name: Fetch Contributors

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:

permissions:
  contents: write

jobs:
  contrib-readme-job:
    name: A job to fetch contributors list
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch contributors list
        uses: akhilmhdh/contributors-readme-action@v2.3.10
        with:
          image_size: 100
          readme_path: "docs/contributors.md"
          collaborators: all
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Save contributors in assets
        if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
        run: |
          printf '%s\n' $(curl "https://api.github.com/repos/Mahmud0808/Iconify/contributors") > ./app/src/main/assets/Misc/contributors.json

      - name: Create a new branch for changes
        id: create_branch
        run: |
          BRANCH_NAME="update-contributors"
          git checkout -b $BRANCH_NAME
          echo "branch=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Commit changes and push to new branch
        uses: github-actions-x/commit@v2.9
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          push-branch: ${{ env.branch }}
          commit-message: 'Update contributors list'
          force-add: 'true'
          files: app/src/main/assets/Misc/contributors.json docs/contributors.md
          name: Mahmud0808
          email: crazymahmud08@gmail.com

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'Update contributors list'
          branch: ${{ env.branch }}
          base: beta
          title: 'Update contributors list'
          body: 'This pull request updates the contributors list.'
          labels: 'auto-generated'

      - name: Close self-created pull requests
        if: github.actor == 'github-actions[bot]'
        run: |
          PR_NUMBER=$(gh pr list --search "Update contributors list" --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            gh pr close $PR_NUMBER
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
